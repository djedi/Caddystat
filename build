#!/bin/bash
set -e

IMAGE_NAME="xhenxhe/caddystat"
VERSION="${1:-latest}"

# Ensure a multi-platform builder exists
if ! docker buildx inspect caddystat-builder &>/dev/null; then
    echo "Creating multi-platform builder..."
    docker buildx create --name caddystat-builder --use
fi
docker buildx use caddystat-builder

echo "Building ${IMAGE_NAME}:${VERSION}..."

# Build for multiple architectures and push
docker buildx build \
    --platform linux/amd64,linux/arm64 \
    -t "${IMAGE_NAME}:${VERSION}" \
    -t "${IMAGE_NAME}:latest" \
    --push \
    .

echo "Done! Pushed ${IMAGE_NAME}:${VERSION} and ${IMAGE_NAME}:latest"
